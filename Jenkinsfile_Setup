pipeline {
    agent {
        docker { 
            image 'python-build'
            args '-u root:root'
        }
    }
    environment {
        DOMAIN = "jenkinsc-${env.BUILD_NUMBER}.comquent.academy" 
        ZONE_NAME = "comquent.academy"
        SSH_KEY_NAME = 'clemens.nikolaus@comquent.de'
        JOB_NAME = 'docker-test'
        SSL_EMAIL = 'clemens.nikolaus@comquent.de'
    }
    stages {
        stage('Checkout Workspace') {
            steps {
                git branch: 'main', url: 'https://github.com/cqNikolaus/jenkins_automation.git'
            }
        }
        stage('Setup Environment') {
            steps {
                withCredentials([
                    sshUserPrivateKey(credentialsId: 'ssh-private-key', keyFileVariable: 'SSH_KEY_FILE'),
                    usernamePassword(credentialsId: 'jenkins-admin-credentials', usernameVariable: 'JENKINS_USER', passwordVariable: 'JENKINS_PASS'),
                    string(credentialsId: 'hetzner-api-token', variable: 'API_TOKEN'),
                    string(credentialsId: 'hetzner-dns-api-token', variable: 'DNS_API_TOKEN')
                ]) {
                    script {
                        // Base64-Kodierung der Credentials
                        def encodedApiToken = sh(script: "echo -n '${API_TOKEN}' | base64", returnStdout: true).trim()
                        def encodedDnsApiToken = sh(script: "echo -n '${DNS_API_TOKEN}' | base64", returnStdout: true).trim()
                        def encodedSshKeyFile = sh(script: "echo -n '${SSH_KEY_FILE}' | base64", returnStdout: true).trim()

                        sh '''
                            set -e
                            # Exportiere die kodierten Variablen
                            export ENCODED_API_TOKEN=''' + encodedApiToken + '''
                            export ENCODED_DNS_API_TOKEN=''' + encodedDnsApiToken + '''
                            export ENCODED_SSH_KEY_FILE=''' + encodedSshKeyFile + '''
                            export JENKINS_USER=''' + "${JENKINS_USER}" + '''
                            export JENKINS_PASS=''' + "${JENKINS_PASS}" + '''
                            echo "set up the environment"
                            pip install -e .
                            python scripts/create_environment.py --config-repo https://github.com/cqNikolaus/jenkins_configs.git --branch bootstrap
                        '''
                    }
                }
            }
        }
    }
}
